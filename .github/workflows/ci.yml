# .github/workflows/run-flask.yml
name: Run Flask → Commit response.txt

on:
  repository_dispatch:
    types: [run_flask]

jobs:
  run-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write # ← THIS IS REQUIRED TO PUSH
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # (Optional: keep your fast Docker cache from before)
      - name: Build & run Flask (cached + fast)
        run: |
          docker build -t flask-app .  # or your cached version
          docker run -d -p 5000:5000 --name flask flask-app
          sleep 5
          curl -s http://localhost:5000/ > response.txt
          docker stop flask || true

      # Commit and push the response file
      - name: Commit response.txt
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add response.txt
          git commit -m "Update Flask response [ci skip]" || echo "No changes"
          git push

      # Print it one last time (for logs)
      - name: Show final response
        run: cat response.txt
